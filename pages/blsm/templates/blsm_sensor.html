{% extends "base.html" %}

{% set title = "Sensor Value" %}
{% set description = "Live sensor reading from r0b0 robot" %}
{% set heading = "Sensor Value" %}
{% set icon = "sliders-h" %}
{% set subheading = "Live sensor reading from robot" %}

{% block content %}
<section class="page-section bg-white" id="sensor">
  <div class="container text-center">
    <h2 class="page-section-heading text-center text-uppercase text-secondary mb-0">
      Current Sensor Value
    </h2>
    <div class="divider-custom">
      <div class="divider-custom-line"></div>
      <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
      <div class="divider-custom-line"></div>
    </div>

    <!-- Status Display -->
    <div class="card bg-light mb-4">
      <div class="card-body">
        <h5 class="card-title">
          <i class="fas fa-circle text-warning me-2" id="connectionIcon"></i>
          Connection Status
        </h5>
        <p class="card-text" id="connectionStatus">Connecting to server...</p>
      </div>
    </div>

    <div class="card bg-light mb-4">
      <div class="card-body">
        <h5 class="card-title">
          <i class="fas fa-wave-square me-2"></i>
          Sensor Value
        </h5>
        <p class="card-text lead" id="sensorValue">--</p>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  let socketAddr = window.location.origin;

  const connectionStatusElement = document.getElementById("connectionStatus");
  const connectionIconElement = document.getElementById("connectionIcon");

  function setConnectionStatus(status, message, iconClass) {
    connectionStatusElement.textContent = message;
    connectionIconElement.className = iconClass;
  }

  setConnectionStatus("connecting", "Connecting to server...", "fas fa-circle text-warning me-2");

  const socket = io.connect(socketAddr, {
    timeout: 5000,
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5,
  });

  socket.on("connect", () => {
    console.log("Connected to the server");
    setConnectionStatus("connected", "Connected to server - Ready to receive sensor data", "fas fa-circle text-success me-2");
  });

  socket.on("disconnect", (reason) => {
    console.log("Disconnected from the server:", reason);
    setConnectionStatus("disconnected", `Disconnected from server (${reason}) - Check connection`, "fas fa-circle text-danger me-2");
  });

  socket.on("connect_error", (error) => {
    console.log("Connection error:", error);
    setConnectionStatus("error", "Connection error - Unable to reach server", "fas fa-circle text-danger me-2");
  });

  socket.on("reconnect", (attemptNumber) => {
    console.log("Reconnected to server after", attemptNumber, "attempts");
    setConnectionStatus("connected", "Reconnected to server - Ready to receive sensor data", "fas fa-circle text-success me-2");
  });

  socket.on("reconnect_attempt", (attemptNumber) => {
    console.log("Attempting to reconnect... attempt", attemptNumber);
    setConnectionStatus("reconnecting", `Reconnecting... (attempt ${attemptNumber})`, "fas fa-circle text-warning me-2");
  });

  socket.on("reconnect_failed", () => {
    console.log("Failed to reconnect");
    setConnectionStatus("failed", "Failed to reconnect - Please refresh the page", "fas fa-circle text-danger me-2");
  });

  socket.onAny((event, ...args) => {
    console.log("Socket event:", event, args);
  });

  socket.on("sensor_value", function (data) {
    console.log(data);
    document.getElementById("sensorValue").textContent = data.value;
  });

  setInterval(() => {
    if (!socket.connected && connectionStatusElement.textContent.includes("Connected")) {
      setConnectionStatus("disconnected", "Connection lost - Attempting to reconnect...", "fas fa-circle text-warning me-2");
    }
  }, 2000);
</script>
{% endblock %}
