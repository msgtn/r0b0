{% extends "base.html" %}

{% set title = "Motor Control" %}
{% set description = "Motor Control and Calibration for r0b0 robot" %}
{% set heading = "Calibration" %}
{% set icon = "sliders-h" %}
{% set subheading = "Robot Motor Calibration and Control" %}

{% block content %}
<section class="page-section bg-white" id="motorcontrol">
  <div class="container">
    <h2 class="page-section-heading text-center text-uppercase text-secondary mb-0">Motor Calibration</h2>
    <div class="divider-custom">
      <div class="divider-custom-line"></div>
      <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
      <div class="divider-custom-line"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-10 text-center">
        <p class="lead mb-4">Use the sliders below to control and calibrate robot motors.</p>

        <!-- Connection Status -->
        <div class="card bg-light mb-4">
          <div class="card-body text-center">
            <h5 class="card-title">
              <i class="fas fa-circle text-warning me-2" id="connectionIcon"></i>
              Connection Status
            </h5>
            <p class="card-text" id="connectionStatus">Connecting to server...</p>
          </div>
        </div>

        <!-- Motor Controls -->
        <div class="row" id="motorControls">
          <!-- Motor sliders will be dynamically generated here -->
        </div>

        <!-- Reset Button -->
        <div class="text-center mt-4">
          <button class="btn btn-primary btn-lg" id="reset-sliders">
            <i class="fas fa-undo me-2"></i>
            Reset to Calibration Position
          </button>
        </div>

        <!-- Instructions -->
        <div class="mt-4">
          <h6 class="text-uppercase mb-3">Instructions</h6>
          <div class="row">
            <div class="col-md-6">
              <p class="small">• Drag sliders to adjust motor positions</p>
              <p class="small">• Changes are sent immediately via WebSocket</p>
            </div>
            <div class="col-md-6">
              <p class="small">• Use reset button to return to calibration position (90°)</p>
              <p class="small">• Monitor connection status above</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  let socketAddr = window.location.origin;

  const connectionStatusElement = document.getElementById('connectionStatus');
  const connectionIconElement = document.getElementById('connectionIcon');
  const motorControlsContainer = document.getElementById('motorControls');

  let sliders = [];

  function setConnectionStatus(status, message, iconClass) {
    connectionStatusElement.textContent = message;
    connectionIconElement.className = iconClass;
  }

  setConnectionStatus('connecting', 'Connecting to server...', 'fas fa-circle text-warning me-2');

  const socket = io.connect(socketAddr, {
    timeout: 5000,
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5
  });

  function updateSliderDisplay(event) {
    if (!socket.connected) return;

    let currentValue = event.target.value;
    let max = event.target.max;
    let id = event.target.id.replace("slider", "");

    document.getElementById(`slider-value${id}`).innerText = `Motor ${id}: ${currentValue}° / ${max}°`;
    socket.emit("slider_event", { id: id, value: currentValue });
    console.log(`Motor ${id}: ${currentValue}`);
  }

  function createMotorSliders() {
    for (let i = 1; i < 5; i++) {
      const colDiv = document.createElement('div');
      colDiv.className = 'col-md-6 col-lg-3 mb-4';

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card h-100';

      const cardBodyDiv = document.createElement('div');
      cardBodyDiv.className = 'card-body text-center';

      const title = document.createElement('h5');
      title.className = 'card-title';
      title.innerHTML = `<i class="fas fa-cog me-2"></i>Motor ${i}`;

      const slider = document.createElement('input');
      slider.id = `slider${i}`;
      slider.type = 'range';
      slider.className = 'form-range mb-3';
      slider.min = 10;
      slider.max = 170;
      slider.value = 90;

      const sliderValue = document.createElement('p');
      sliderValue.id = `slider-value${i}`;
      sliderValue.className = 'card-text';
      sliderValue.innerText = `Motor ${i}: 90° / 170°`;

      slider.addEventListener('input', updateSliderDisplay);

      cardBodyDiv.appendChild(title);
      cardBodyDiv.appendChild(slider);
      cardBodyDiv.appendChild(sliderValue);
      cardDiv.appendChild(cardBodyDiv);
      colDiv.appendChild(cardDiv);

      motorControlsContainer.appendChild(colDiv);
      sliders.push(slider);
    }
  }

  document.getElementById("reset-sliders").onclick = function () {
    sliders.forEach((slider) => {
      slider.value = 90;
      slider.dispatchEvent(new Event("input"));
    });
  };

  socket.on('connect', () => {
    console.log('Connected to the server');
    setConnectionStatus('connected', 'Connected to server - Motor controls active', 'fas fa-circle text-success me-2');
  });

  socket.on('disconnect', (reason) => {
    console.log('Disconnected from the server:', reason);
    setConnectionStatus('disconnected', `Disconnected from server (${reason}) - Motor controls inactive`, 'fas fa-circle text-danger me-2');
  });

  socket.on('connect_error', (error) => {
    console.log('Connection error:', error);
    setConnectionStatus('error', 'Connection error - Unable to reach server', 'fas fa-circle text-danger me-2');
  });

  socket.on('reconnect', (attemptNumber) => {
    console.log('Reconnected to server after', attemptNumber, 'attempts');
    setConnectionStatus('connected', 'Reconnected to server - Motor controls active', 'fas fa-circle text-success me-2');
  });

  socket.on('reconnect_attempt', (attemptNumber) => {
    console.log('Attempting to reconnect... attempt', attemptNumber);
    setConnectionStatus('reconnecting', `Reconnecting... (attempt ${attemptNumber})`, 'fas fa-circle text-warning me-2');
  });

  socket.on('reconnect_failed', () => {
    console.log('Failed to reconnect');
    setConnectionStatus('failed', 'Failed to reconnect - Please refresh the page', 'fas fa-circle text-danger me-2');
  });

  document.addEventListener('DOMContentLoaded', createMotorSliders);
</script>
{% endblock %}
