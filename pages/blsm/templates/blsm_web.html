{% extends "base.html" %}

{% set title = "Key Events" %}
{% set description = "Key Event Listener for r0b0 robot control" %}
{% set heading = "Key Events" %}
{% set icon = "keyboard" %}
{% set subheading = "Keyboard Input Capture for Robot Control" %}

{% block content %}
<section class="page-section bg-white" id="keyevents">
  <div class="container">
    <h2 class="page-section-heading text-center text-uppercase text-secondary mb-0">
      Key Event Listener
    </h2>
    <div class="divider-custom">
      <div class="divider-custom-line"></div>
      <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
      <div class="divider-custom-line"></div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <p class="lead mb-4">
          Press any key on your keyboard to send control signals to the robot.
        </p>

        <!-- Status Display -->
        <div class="card bg-light mb-4">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-circle text-warning me-2" id="connectionIcon"></i>
              Connection Status
            </h5>
            <p class="card-text" id="connectionStatus">Connecting to server...</p>
          </div>
        </div>

        <!-- Key Event Display -->
        <div class="card bg-primary text-white">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-keyboard me-2"></i>
              Last Key Event
            </h5>
            <p class="card-text lead" id="status">Waiting for key events...</p>
          </div>
        </div>

        <!-- Instructions -->
        <div class="mt-4">
          <h6 class="text-uppercase mb-3">Instructions</h6>
          <div class="row">
            <div class="col-md-6">
              <p class="small">• Press any key to send control signals</p>
              <p class="small">• Key events are sent immediately via WebSocket</p>
            </div>
            <div class="col-md-6">
              <p class="small">• Check connection status above</p>
              <p class="small">• Use different keys for different robot actions</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  let socketAddr = window.location.origin;

  const statusElement = document.getElementById("status");
  const connectionStatusElement = document.getElementById("connectionStatus");
  const connectionIconElement = document.getElementById("connectionIcon");

  function setConnectionStatus(status, message, iconClass) {
    connectionStatusElement.textContent = message;
    connectionIconElement.className = iconClass;
  }

  setConnectionStatus("connecting", "Connecting to server...", "fas fa-circle text-warning me-2");

  const socket = io.connect(socketAddr, {
    timeout: 5000,
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5,
  });

  document.addEventListener("keydown", (event) => {
    if (!socket.connected) {
      statusElement.textContent = "Cannot send key events - Not connected to server";
      return;
    }

    const key = event.key;
    const code = event.code;
    socket.emit("key_event", { key, code });
    statusElement.textContent = `Key pressed: ${key} (Code: ${code})`;

    statusElement.parentElement.classList.add("bg-success");
    statusElement.parentElement.classList.remove("bg-primary");
    setTimeout(() => {
      statusElement.parentElement.classList.remove("bg-success");
      statusElement.parentElement.classList.add("bg-primary");
    }, 200);
  });

  socket.on("connect", () => {
    console.log("Connected to the server");
    setConnectionStatus("connected", "Connected to server - Ready to capture key events", "fas fa-circle text-success me-2");
  });

  socket.on("disconnect", (reason) => {
    console.log("Disconnected from the server:", reason);
    setConnectionStatus("disconnected", `Disconnected from server (${reason}) - Check connection`, "fas fa-circle text-danger me-2");
    statusElement.textContent = "Disconnected - Key events will not be sent";
  });

  socket.on("connect_error", (error) => {
    console.log("Connection error:", error);
    setConnectionStatus("error", "Connection error - Unable to reach server", "fas fa-circle text-danger me-2");
    statusElement.textContent = "Connection failed - Check if server is running";
  });

  socket.on("reconnect", (attemptNumber) => {
    console.log("Reconnected to server after", attemptNumber, "attempts");
    setConnectionStatus("connected", "Reconnected to server - Ready to capture key events", "fas fa-circle text-success me-2");
  });

  socket.on("reconnect_attempt", (attemptNumber) => {
    console.log("Attempting to reconnect... attempt", attemptNumber);
    setConnectionStatus("reconnecting", `Reconnecting... (attempt ${attemptNumber})`, "fas fa-circle text-warning me-2");
  });

  socket.on("reconnect_failed", () => {
    console.log("Failed to reconnect");
    setConnectionStatus("failed", "Failed to reconnect - Please refresh the page", "fas fa-circle text-danger me-2");
  });

  setInterval(() => {
    if (!socket.connected && connectionStatusElement.textContent.includes("Connected")) {
      setConnectionStatus("disconnected", "Connection lost - Attempting to reconnect...", "fas fa-circle text-warning me-2");
    }
  }, 2000);
</script>
{% endblock %}
