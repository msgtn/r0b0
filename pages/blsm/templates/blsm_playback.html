<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Tape Playback for r0b0 robot control" />
    <meta name="author" content="" />
    <title>Playback - r0b0 Framework</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="/main/assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <!-- Google fonts-->
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic"
      rel="stylesheet"
      type="text/css"
    />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/main/css/styles.css" rel="stylesheet" />
    <!-- Include Socket.IO -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
    <style>
      .tape-list {
        max-height: 300px;
        overflow-y: auto;
      }
      .tape-item {
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .tape-item:hover {
        background-color: #f8f9fa;
      }
      .tape-item.selected {
        background-color: #1abc9c;
        color: white;
      }
      .playback-controls .btn {
        min-width: 100px;
      }
      .progress-container {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background-color: #1abc9c;
        transition: width 0.1s linear;
      }
      .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
    </style>
  </head>
  <body id="page-top">
    <!-- Navigation-->
    <nav
      class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top"
      id="mainNav"
    >
      <div class="container">
        <a class="navbar-brand" href="/">r0b0</a>
        <button
          class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded" href="/">Home</a>
            </li>
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded" href="/blsm_web"
                >Key Events</a
              >
            </li>
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded" href="/blsm_calib"
                >Calibration</a
              >
            </li>
            <li class="nav-item mx-0 mx-lg-1">
              <a
                class="nav-link py-3 px-0 px-lg-3 rounded"
                href="/blsm_playback"
                >Playback</a
              >
            </li>
            <li class="nav-item dropdown mx-0 mx-lg-1">
              <a
                class="nav-link dropdown-toggle py-3 px-0 px-lg-3 rounded"
                href="#"
                id="menuDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                >Menu</a
              >
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="menuDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/blsm_sensor">Sensor</a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://github.com/msgtn/r0b0"
                    target="_blank"
                    >GitHub</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Masthead-->
    <header class="masthead bg-primary text-white text-center">
      <div class="container d-flex align-items-center flex-column">
        <h1 class="masthead-heading text-uppercase mb-0">Tape Playback</h1>
        <div class="divider-custom divider-light">
          <div class="divider-custom-line"></div>
          <div class="divider-custom-icon">
            <i class="fas fa-play-circle"></i>
          </div>
          <div class="divider-custom-line"></div>
        </div>
        <p class="masthead-subheading font-weight-light mb-0">
          Play recorded motion sequences
        </p>
      </div>
    </header>

    <!-- Playback Section -->
    <section class="page-section bg-white" id="playback">
      <div class="container">
        <h2
          class="page-section-heading text-center text-uppercase text-secondary mb-0"
        >
          Playback Controls
        </h2>

        <div class="divider-custom">
          <div class="divider-custom-line"></div>
          <div class="divider-custom-icon"><i class="fas fa-film"></i></div>
          <div class="divider-custom-line"></div>
        </div>

        <div class="row justify-content-center">
          <!-- Connection Status -->
          <div class="col-lg-8 mb-4">
            <div class="card bg-light">
              <div class="card-body">
                <h5 class="card-title">
                  <i
                    class="fas fa-circle text-warning me-2"
                    id="connectionIcon"
                  ></i>
                  Connection Status
                </h5>
                <p class="card-text mb-0" id="connectionStatus">
                  Connecting to server...
                </p>
              </div>
            </div>
          </div>

          <!-- Tape Selection -->
          <div class="col-lg-8 mb-4">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list me-2"></i>Available Tapes</span>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshTapes()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
              <div class="card-body">
                <div class="tape-list list-group" id="tapeList">
                  <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin"></i> Loading tapes...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Playback Status -->
          <div class="col-lg-8 mb-4">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Now Playing
              </div>
              <div class="card-body text-center">
                <h4 id="currentTapeName" class="mb-3">No tape selected</h4>
                <div class="mb-3">
                  <span class="badge status-badge bg-secondary" id="playbackStatus">Stopped</span>
                </div>
                <div class="progress-container mb-3">
                  <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <small class="text-muted">
                  <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                </small>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="col-lg-8 mb-4">
            <div class="card">
              <div class="card-header">
                <i class="fas fa-gamepad me-2"></i>Controls
              </div>
              <div class="card-body">
                <div class="playback-controls d-flex justify-content-center gap-3 mb-4">
                  <button class="btn btn-success btn-lg" id="playBtn" onclick="playTape()">
                    <i class="fas fa-play me-2"></i>Play
                  </button>
                  <button class="btn btn-warning btn-lg" id="pauseBtn" onclick="pauseTape()" disabled>
                    <i class="fas fa-pause me-2"></i>Pause
                  </button>
                  <button class="btn btn-danger btn-lg" id="stopBtn" onclick="stopTape()" disabled>
                    <i class="fas fa-stop me-2"></i>Stop
                  </button>
                </div>
                <div class="d-flex justify-content-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="loopCheckbox">
                    <label class="form-check-label" for="loopCheckbox">
                      <i class="fas fa-redo me-1"></i>Loop playback
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer-->
    <footer class="footer text-center">
      <div class="container">
        <div class="row">
          <div class="col-lg-4 mb-5 mb-lg-0">
            <h4 class="text-uppercase mb-4">r0b0 Framework</h4>
            <p class="lead mb-0">
              Communication library for<br />
              hardware and software
            </p>
          </div>
          <div class="col-lg-4 mb-5 mb-lg-0">
            <h4 class="text-uppercase mb-4">Links</h4>
            <a
              class="btn btn-outline-light btn-social mx-1"
              href="https://github.com/msgtn/r0b0"
              target="_blank"
              ><i class="fab fa-fw fa-github"></i
            ></a>
            <a class="btn btn-outline-light btn-social mx-1" href="/blsm_web"
              ><i class="fas fa-fw fa-keyboard"></i
            ></a>
            <a class="btn btn-outline-light btn-social mx-1" href="/blsm_calib"
              ><i class="fas fa-fw fa-sliders-h"></i
            ></a>
          </div>
          <div class="col-lg-4">
            <h4 class="text-uppercase mb-4">Open Source</h4>
            <p class="lead mb-0">
              Licensed under AGPL-3.0<br />
              <a href="https://github.com/msgtn/r0b0">View Source Code</a>
            </p>
          </div>
        </div>
      </div>
    </footer>
    <!-- Copyright Section-->
    <div class="copyright py-4 text-center text-white">
      <div class="container">
        <small>Copyright &copy; r0b0 Framework 2023</small>
      </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="/main/js/scripts.js"></script>

    <!-- Playback Script -->
    <script>
      const socketAddr = window.location.origin;
      let selectedTapeName = null;
      let isPlaying = false;
      let isPaused = false;

      // DOM elements
      const connectionStatusElement = document.getElementById("connectionStatus");
      const connectionIconElement = document.getElementById("connectionIcon");
      const tapeListElement = document.getElementById("tapeList");
      const currentTapeNameElement = document.getElementById("currentTapeName");
      const playbackStatusElement = document.getElementById("playbackStatus");
      const progressBarElement = document.getElementById("progressBar");
      const currentTimeElement = document.getElementById("currentTime");
      const totalTimeElement = document.getElementById("totalTime");
      const playBtn = document.getElementById("playBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const stopBtn = document.getElementById("stopBtn");
      const loopCheckbox = document.getElementById("loopCheckbox");

      // Connection status helper
      function setConnectionStatus(status, message, iconClass) {
        connectionStatusElement.textContent = message;
        connectionIconElement.className = iconClass;
      }

      // Format time as M:SS
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      // Update UI based on playback state
      function updatePlaybackUI(state) {
        switch (state) {
          case "playing":
            isPlaying = true;
            isPaused = false;
            playbackStatusElement.textContent = "Playing";
            playbackStatusElement.className = "badge status-badge bg-success";
            playBtn.disabled = true;
            pauseBtn.disabled = false;
            stopBtn.disabled = false;
            break;
          case "paused":
            isPlaying = false;
            isPaused = true;
            playbackStatusElement.textContent = "Paused";
            playbackStatusElement.className = "badge status-badge bg-warning";
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = false;
            break;
          case "stopped":
          default:
            isPlaying = false;
            isPaused = false;
            playbackStatusElement.textContent = "Stopped";
            playbackStatusElement.className = "badge status-badge bg-secondary";
            playBtn.disabled = selectedTapeName === null;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            progressBarElement.style.width = "0%";
            currentTimeElement.textContent = "0:00";
            break;
        }
      }

      // Select a tape from the list
      function selectTape(tapeName) {
        selectedTapeName = tapeName;
        currentTapeNameElement.textContent = tapeName;

        // Update list item selection
        document.querySelectorAll(".tape-item").forEach((item) => {
          item.classList.remove("selected");
          if (item.dataset.tape === tapeName) {
            item.classList.add("selected");
          }
        });

        // Enable play button
        playBtn.disabled = false;
      }

      // Fetch and display available tapes
      function refreshTapes() {
        tapeListElement.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="fas fa-spinner fa-spin"></i> Loading tapes...
          </div>
        `;

        fetch(`${socketAddr}/api/tapes`)
          .then((response) => response.json())
          .then((data) => {
            if (data.tapes && data.tapes.length > 0) {
              tapeListElement.innerHTML = "";
              data.tapes.forEach((tape) => {
                const item = document.createElement("button");
                item.type = "button";
                item.className = "list-group-item list-group-item-action tape-item";
                item.dataset.tape = tape.name;
                item.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-film me-2"></i>${tape.name}</span>
                    <small class="text-muted">${formatTime(tape.duration || 0)}</small>
                  </div>
                `;
                item.onclick = () => selectTape(tape.name);
                tapeListElement.appendChild(item);
              });
            } else {
              tapeListElement.innerHTML = `
                <div class="text-center text-muted py-3">
                  <i class="fas fa-inbox"></i> No tapes available
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Error fetching tapes:", error);
            tapeListElement.innerHTML = `
              <div class="text-center text-danger py-3">
                <i class="fas fa-exclamation-triangle"></i> Error loading tapes
              </div>
            `;
          });
      }

      // Playback controls
      function playTape() {
        if (!selectedTapeName) return;
        socket.emit("playback_play", {
          tape_name: selectedTapeName,
          loop: loopCheckbox.checked,
        });
      }

      function pauseTape() {
        socket.emit("playback_pause", {});
      }

      function stopTape() {
        socket.emit("playback_stop", {});
      }

      // Initialize Socket.IO connection
      const socket = io.connect(socketAddr, {
        timeout: 5000,
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5,
      });

      // Socket event handlers
      socket.on("connect", () => {
        console.log("Connected to server");
        setConnectionStatus(
          "connected",
          "Connected to server",
          "fas fa-circle text-success me-2"
        );
        refreshTapes();
      });

      socket.on("disconnect", (reason) => {
        console.log("Disconnected:", reason);
        setConnectionStatus(
          "disconnected",
          `Disconnected (${reason})`,
          "fas fa-circle text-danger me-2"
        );
      });

      socket.on("connect_error", (error) => {
        console.log("Connection error:", error);
        setConnectionStatus(
          "error",
          "Connection error",
          "fas fa-circle text-danger me-2"
        );
      });

      // Playback status updates from server
      socket.on("playback_status", (data) => {
        console.log("Playback status:", data);
        updatePlaybackUI(data.state);

        if (data.tape_name) {
          currentTapeNameElement.textContent = data.tape_name;
        }

        if (data.progress !== undefined) {
          progressBarElement.style.width = `${data.progress * 100}%`;
        }

        if (data.current_time !== undefined) {
          currentTimeElement.textContent = formatTime(data.current_time);
        }

        if (data.total_time !== undefined) {
          totalTimeElement.textContent = formatTime(data.total_time);
        }
      });

      // Initial state
      setConnectionStatus(
        "connecting",
        "Connecting to server...",
        "fas fa-circle text-warning me-2"
      );
      updatePlaybackUI("stopped");
    </script>
  </body>
</html>
