{% extends "base.html" %}

{% set title = "Playback" %}
{% set description = "Tape Playback for r0b0 robot control" %}
{% set heading = "Tape Playback" %}
{% set icon = "play-circle" %}

{% block head_extra %}
<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<style>
  .tape-list {
    max-height: 200px;
    overflow-y: auto;
  }
  .tape-item {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .tape-item:hover {
    background-color: #f8f9fa;
  }
  .tape-item.selected {
    background-color: #1abc9c;
    color: white;
  }
  .playback-controls .btn {
    min-width: 80px;
  }
  .progress-container {
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background-color: #1abc9c;
    transition: width 0.1s linear;
  }
  .status-badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
  }
  #visualizer-container {
    height: 350px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    overflow: hidden;
  }
  .scrubber-container {
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  .scrubber-slider {
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    background: #e9ecef;
    border-radius: 4px;
    outline: none;
  }
  .scrubber-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: #1abc9c;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .scrubber-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }
  .scrubber-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: #1abc9c;
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }
  .pose-info {
    font-family: monospace;
    font-size: 0.85rem;
  }
  .sync-badge {
    font-size: 0.75rem;
  }
</style>
{% endblock %}

{% block masthead_style %}style="padding-top: 8rem; padding-bottom: 4rem;"{% endblock %}
{% block heading_style %}style="font-size: 2rem;"{% endblock %}

{% block content %}
<section class="page-section bg-white py-4" id="playback">
  <div class="container">
    <!-- Connection Status -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card bg-light">
          <div class="card-body py-2">
            <span>
              <i class="fas fa-circle text-warning me-2" id="connectionIcon"></i>
              <span id="connectionStatus">Connecting to server...</span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Left Column: Tape Selection + Controls -->
      <div class="col-lg-4 mb-4">
        <!-- Tape Selection -->
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center py-2">
            <span><i class="fas fa-list me-2"></i>Tapes</span>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshTapes()">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="card-body p-2">
            <div class="tape-list list-group list-group-flush" id="tapeList">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Loading...
              </div>
            </div>
          </div>
        </div>

        <!-- Playback Status -->
        <div class="card mb-3">
          <div class="card-header py-2">
            <i class="fas fa-info-circle me-2"></i>Now Playing
          </div>
          <div class="card-body text-center py-3">
            <h5 id="currentTapeName" class="mb-2">No tape selected</h5>
            <span class="badge status-badge bg-secondary" id="playbackStatus">Stopped</span>
            <div class="progress-container my-2">
              <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <small class="text-muted">
              <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
            </small>
          </div>
        </div>

        <!-- Controls -->
        <div class="card">
          <div class="card-header py-2">
            <i class="fas fa-gamepad me-2"></i>Controls
          </div>
          <div class="card-body py-3">
            <div class="playback-controls d-flex justify-content-center gap-2 mb-3">
              <button class="btn btn-success" id="playBtn" onclick="playTape()">
                <i class="fas fa-play"></i>
              </button>
              <button class="btn btn-warning" id="pauseBtn" onclick="pauseTape()" disabled>
                <i class="fas fa-pause"></i>
              </button>
              <button class="btn btn-danger" id="stopBtn" onclick="stopTape()" disabled>
                <i class="fas fa-stop"></i>
              </button>
            </div>
            <div class="d-flex justify-content-center gap-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="loopCheckbox">
                <label class="form-check-label" for="loopCheckbox">Loop</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="syncCheckbox" checked>
                <label class="form-check-label" for="syncCheckbox">
                  Sync
                  <span class="badge bg-info sync-badge" id="syncBadge">ON</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Visualizer + Scrubber -->
      <div class="col-lg-8 mb-4">
        <!-- 3D Visualizer -->
        <div class="card mb-3">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="fas fa-cube me-2"></i>3D Preview</span>
            <span class="pose-info text-muted" id="poseInfo">H: 0 | Y: 0° P: 0° R: 0°</span>
          </div>
          <div class="card-body p-0">
            <div id="visualizer-container"></div>
          </div>
        </div>

        <!-- Timeline Scrubber -->
        <div class="card">
          <div class="card-header py-2">
            <i class="fas fa-sliders-h me-2"></i>Timeline Scrubber
            <small class="text-muted ms-2">(Preview mode when Sync is OFF)</small>
          </div>
          <div class="card-body">
            <div class="scrubber-container">
              <input type="range" class="scrubber-slider" id="scrubberSlider"
                min="0" max="100" value="0" step="0.1" />
              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted" id="scrubberTime">0:00</small>
                <small class="text-muted" id="scrubberDuration">0:00</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block footer_class %}py-4{% endblock %}

{% block scripts %}
<!-- Visualizer JS -->
<script src="{{ url_for('static', filename='visualizer.js') }}"></script>

<script>
  const socketAddr = window.location.origin;
  let selectedTapeName = null;
  let selectedTapeDuration = 0;
  let isPlaying = false;
  let isPaused = false;
  let syncMode = true;
  let visualizer = null;

  const connectionStatusElement = document.getElementById("connectionStatus");
  const connectionIconElement = document.getElementById("connectionIcon");
  const tapeListElement = document.getElementById("tapeList");
  const currentTapeNameElement = document.getElementById("currentTapeName");
  const playbackStatusElement = document.getElementById("playbackStatus");
  const progressBarElement = document.getElementById("progressBar");
  const currentTimeElement = document.getElementById("currentTime");
  const totalTimeElement = document.getElementById("totalTime");
  const playBtn = document.getElementById("playBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn = document.getElementById("stopBtn");
  const loopCheckbox = document.getElementById("loopCheckbox");
  const syncCheckbox = document.getElementById("syncCheckbox");
  const syncBadge = document.getElementById("syncBadge");
  const scrubberSlider = document.getElementById("scrubberSlider");
  const scrubberTime = document.getElementById("scrubberTime");
  const scrubberDuration = document.getElementById("scrubberDuration");
  const poseInfo = document.getElementById("poseInfo");

  function initVisualizer() {
    const container = document.getElementById("visualizer-container");
    if (container && typeof BlsmVisualizer !== "undefined") {
      visualizer = new BlsmVisualizer(container);
    }
  }

  function setConnectionStatus(status, message, iconClass) {
    connectionStatusElement.textContent = message;
    connectionIconElement.className = iconClass;
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  }

  function updatePoseInfo(h, yaw, pitch, roll) {
    const toDeg = (rad) => (rad * 180 / Math.PI).toFixed(1);
    poseInfo.textContent = `H: ${h.toFixed(0)} | Y: ${toDeg(yaw)}° P: ${toDeg(pitch)}° R: ${toDeg(roll)}°`;
  }

  function updatePlaybackUI(state) {
    switch (state) {
      case "playing":
        isPlaying = true;
        isPaused = false;
        playbackStatusElement.textContent = "Playing";
        playbackStatusElement.className = "badge status-badge bg-success";
        playBtn.disabled = true;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
        break;
      case "paused":
        isPlaying = false;
        isPaused = true;
        playbackStatusElement.textContent = "Paused";
        playbackStatusElement.className = "badge status-badge bg-warning";
        playBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = false;
        break;
      case "stopped":
      default:
        isPlaying = false;
        isPaused = false;
        playbackStatusElement.textContent = "Stopped";
        playbackStatusElement.className = "badge status-badge bg-secondary";
        playBtn.disabled = selectedTapeName === null;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        progressBarElement.style.width = "0%";
        currentTimeElement.textContent = "0:00";
        break;
    }
  }

  async function loadTapeFrames(tapeName) {
    try {
      const response = await fetch(`${socketAddr}/api/tape/${tapeName}/frames`);
      const data = await response.json();
      if (data.frames && visualizer) {
        visualizer.loadTapeFrames(data.frames, data.duration);
        selectedTapeDuration = data.duration;
        scrubberDuration.textContent = formatTime(data.duration);
        totalTimeElement.textContent = formatTime(data.duration);
      }
    } catch (error) {
      console.error("Error loading tape frames:", error);
    }
  }

  function selectTape(tapeName, duration) {
    selectedTapeName = tapeName;
    selectedTapeDuration = duration || 0;
    currentTapeNameElement.textContent = tapeName;
    totalTimeElement.textContent = formatTime(duration || 0);
    scrubberDuration.textContent = formatTime(duration || 0);

    document.querySelectorAll(".tape-item").forEach((item) => {
      item.classList.remove("selected");
      if (item.dataset.tape === tapeName) {
        item.classList.add("selected");
      }
    });

    playBtn.disabled = false;
    loadTapeFrames(tapeName);
  }

  function refreshTapes() {
    tapeListElement.innerHTML = `
      <div class="text-center text-muted py-3">
        <i class="fas fa-spinner fa-spin"></i> Loading...
      </div>
    `;

    fetch(`${socketAddr}/api/tapes`)
      .then((response) => response.json())
      .then((data) => {
        if (data.tapes && data.tapes.length > 0) {
          tapeListElement.innerHTML = "";
          data.tapes.forEach((tape) => {
            const item = document.createElement("button");
            item.type = "button";
            item.className = "list-group-item list-group-item-action tape-item py-2";
            item.dataset.tape = tape.name;
            item.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-film me-2"></i>${tape.name}</span>
                <small class="text-muted">${formatTime(tape.duration || 0)}</small>
              </div>
            `;
            item.onclick = () => selectTape(tape.name, tape.duration);
            tapeListElement.appendChild(item);
          });
        } else {
          tapeListElement.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-inbox"></i> No tapes
            </div>
          `;
        }
      })
      .catch((error) => {
        console.error("Error fetching tapes:", error);
        tapeListElement.innerHTML = `
          <div class="text-center text-danger py-3">
            <i class="fas fa-exclamation-triangle"></i> Error
          </div>
        `;
      });
  }

  function playTape() {
    if (!selectedTapeName) return;
    socket.emit("playback_play", {
      tape_name: selectedTapeName,
      loop: loopCheckbox.checked,
    });
  }

  function pauseTape() {
    socket.emit("playback_pause", {});
  }

  function stopTape() {
    socket.emit("playback_stop", {});
    if (visualizer) {
      visualizer.scrubToProgress(0);
      scrubberSlider.value = 0;
      scrubberTime.textContent = "0:00";
    }
  }

  syncCheckbox.addEventListener("change", (e) => {
    syncMode = e.target.checked;
    syncBadge.textContent = syncMode ? "ON" : "OFF";
    syncBadge.className = syncMode ? "badge bg-info sync-badge" : "badge bg-secondary sync-badge";
  });

  scrubberSlider.addEventListener("input", (e) => {
    if (syncMode && isPlaying) return;

    const progress = e.target.value / 100;
    const time = progress * selectedTapeDuration;
    scrubberTime.textContent = formatTime(time);

    if (visualizer) {
      visualizer.scrubToProgress(progress);
      const pose = visualizer.currentPose;
      updatePoseInfo(pose.h, pose.yaw, pose.pitch, pose.roll);
    }
  });

  const socket = io.connect(socketAddr, {
    timeout: 5000,
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5,
  });

  socket.on("connect", () => {
    console.log("Connected to server");
    setConnectionStatus("connected", "Connected to server", "fas fa-circle text-success me-2");
    refreshTapes();
  });

  socket.on("disconnect", (reason) => {
    console.log("Disconnected:", reason);
    setConnectionStatus("disconnected", `Disconnected (${reason})`, "fas fa-circle text-danger me-2");
  });

  socket.on("connect_error", (error) => {
    console.log("Connection error:", error);
    setConnectionStatus("error", "Connection error", "fas fa-circle text-danger me-2");
  });

  socket.on("playback_status", (data) => {
    console.log("Playback status:", data);
    updatePlaybackUI(data.state);

    if (data.tape_name) {
      currentTapeNameElement.textContent = data.tape_name;
    }

    if (data.progress !== undefined) {
      progressBarElement.style.width = `${data.progress * 100}%`;

      if (syncMode) {
        scrubberSlider.value = data.progress * 100;
        const time = data.progress * selectedTapeDuration;
        scrubberTime.textContent = formatTime(time);
      }
    }

    if (data.current_time !== undefined) {
      currentTimeElement.textContent = formatTime(data.current_time);
    }

    if (data.total_time !== undefined) {
      totalTimeElement.textContent = formatTime(data.total_time);
    }
  });

  socket.on("playback_pose", (data) => {
    if (syncMode && visualizer) {
      visualizer.updatePose(data.h, data.yaw, data.pitch, data.roll);
      updatePoseInfo(data.h, data.yaw, data.pitch, data.roll);

      if (data.progress !== undefined) {
        scrubberSlider.value = data.progress * 100;
        const time = data.progress * selectedTapeDuration;
        scrubberTime.textContent = formatTime(time);
      }
    }
  });

  setConnectionStatus("connecting", "Connecting to server...", "fas fa-circle text-warning me-2");
  updatePlaybackUI("stopped");

  document.addEventListener("DOMContentLoaded", initVisualizer);
  if (document.readyState !== "loading") {
    initVisualizer();
  }
</script>
{% endblock %}
